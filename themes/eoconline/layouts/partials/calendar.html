{{ $context := .context }}
{{ $from := int .from }}
{{ $fromMonth := int .fromMonth }}
{{ $to := int .to }}
{{ $toMonth := int .toMonth }}
{{ $pages := .pages }}

{{ $view1_title := "Just Years with insights, no months" }}
{{ $view1_text := "Years, no months" }}

{{ $view2_title := "Just Years with insights, just months with insights" }}
{{ $view2_text := "Years + months" }}

{{ $view3_title := "Just Years with insights, just months with insights, plus calendars" }}
{{ $view3_text := "Years + months + calendars" }}

{{ $view4_title := "All Years, display months and calendars" }}
{{ $view4_text := "All" }}

{{ $view5_title := "Hide entire Calendar widget" }}
{{ $view5_text := "Hide" }}


<!--
works:
  { site.Data | jsonify }}
  { printf "%#v" . }}

  {< myParam "yyyyyyyyy" >}}  -- only works in MD files!

  HUGO.toml:
    [[Params.skin]]
		  show_generated_by = true

   partials/footer.html:
    { if .Site.Params.skin.show_generated_by }}  - I think Params is deprecated, so remove that one word...

  { $myParams := .Params }}

is true:
{ strings.Contains ( . | jsonify) "yyyy" }}

yy =
{ .Site.yyyyyyyyy }}
.Site.Author2.name =
{ .Site.author2.name }}
params.author2.name = { .params.author2.name }} -
{ .Params.author2.name }}
  -->

<!--
  Calendar to call year with From:
  {$from }}-{ $fromMonth }}
  To: { $to }}-{ $toMonth }} <br />

  # of pages =
  { (len .pages) }}
-->

{{ $context.Scratch.Set "currentYear" $from }}
{{ $context.Scratch.Add "consideredYears" (slice $from) }}

{{ range ($pages.GroupByPublishDate "2006") }}
  {{ $context.Scratch.SetInMap "ArticlesPerYear" .Key ((len .Pages)) }}
{{ end }}

{{ range ($pages.GroupByPublishDate "2006-01") }}
  {{ $context.Scratch.SetInMap "ArticlesPerMonth" .Key (len .Pages) }}
{{ end }}

{{ range ($pages.GroupByPublishDate "2006-01-02") }}
  {{ $context.Scratch.SetInMap "ArticlesPerDay" .Key (len .Pages) }}
{{ end }}

{{ range $i, $sequence := (seq ((sub $to $from))) }}
  {{ $currentYear := $context.Scratch.Get "currentYear" }}
  {{ $nextYear := (add $from $sequence) }}

  {{ if le $nextYear $to }}
    {{ $context.Scratch.Add "consideredYears" ($nextYear) }}
    <!-- had been: $context.Scratch.Add "consideredYears" (slice $nextYear) }} -->
    {{ $context.Scratch.Set "currentYear" $nextYear }}
    <!-- br />Adding consideredYears: slice { $nextYear }}<br /-->
  {{ end }}

{{ end }}


<!-- BUG: Must be run twice to work the first time! -->
<!-- Drop down button with various views:
      1) Years: Just Years with insights, no months
      2) Months: Just Years with insights, just months with insights
      3) Calendars: Just Years with insights, just months with insights, plus calendars
      4) All: All Years, display months and calendars
      5) Hide: Hide entire Calendar widget
     -->

<!-- div class="float-right dropdown" aria-label="View dropdown">
  <button class="px-2 bg-gray-200 rounded-md hover:bg-blue-200 hover:hidden">Views</button>
  <div class="hidden float-right px-6 bg-gray-200 divide-y rounded-md shadow-lg dropdown-content z-1 divide-lime-600">
    <div class="font-semibold divide-y-8 divide-red-1000">Views</div>

    <div class="rounded-md hover:bg-blue-200" onclick="displayAllYears()" title="Just Years with insights, no months">Years</div>
    <div class="rounded-md hover:bg-blue-200" onclick="displayAllMonths()" title="Just Years with insights, just months with insights">Months</div>
    <div class="hover:bg-blue-200" onclick="toggleCalendars()" title="Just Years with insights, just months with insights, plus calendars">Calendars</div>
    <div class="hover:bg-blue-200" onclick="displayEverything()" title="All Years, display months and calendars">All</div>
    <div class="rounded-md hover:bg-blue-200" onclick="hideEntireCalendar()" title="Hide entire Calendar widget">None</div>
  </div>
</div>

<Following works, but supplanted by the above dropdown
<button type="button" onclick="toggleCalendars()" title="Toggle display of mini-calenders for selected years" id="toggleCalendar" class="float-right bg-gray-200 rounded-lg hover:bg-sky-300">&nbsp;&nbsp;Show Calendars&nbsp;&nbsp;</button>

<button type="button" onclick="toggleMonths()" title="Toggle display of months for all years" id="toggleMonths" class="float-right mr-2 bg-gray-200 rounded-lg hover:bg-sky-300">&nbsp;&nbsp;Show Months&nbsp;&nbsp;</button>
-->

<!-- relies on "require('@tailwindcss/forms')" in tailwind.config.js
 oninput="displayEverything()" onblur="displayEverything()"
  onchange="displayEverything()"
-->
<div class="block text-right">
  <label for="viewSelect" class="text-sm font-semibold leading-6 text-gray-900">View: &nbsp;</label>
  <select id="viewSelect" name="viewSelect" class="py-0 pl-2 pr-10 mt-2 text-gray-900 border-0 rounded-md ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6" oninput="changeView()">
    <option selected title="{{ $view1_title }}">{{ $view1_text }}</option>
    <option title="{{ $view2_title }}">{{ $view2_text }}</option>
    <option title="{{ $view3_title }}">{{ $view3_text }}</option>
    <option title="{{ $view4_title }}">{{ $view4_text }}</option>
    <option title="{{ $view5_title }}">{{ $view5_text }}</option>
  </select>
</div>

{{ range ($context.Scratch.Get "consideredYears") }}
  <!--
      <br />Calendar calling year '{ . }}' with From: { $from }}-{ $fromMonth }} To: { $to }}-{ $toMonth }}<br />
    -->
  {{ partialCached "calendar/year" (dict "context" $context "year" . "from" $from "fromMonth" $fromMonth "to" $to
    "toMonth" $toMonth) (string (delimit (slice $from $fromMonth $to $toMonth .) ""))
  }}
{{ end }}

<script>

  // setting for all years, not just one
  let monthsVisible = false;
  let displayAll = false;

  // run initially: Add event listeners to all years
  let years = document.querySelectorAll("[toggle-year]");
  for (let i = 0; i < years.length; i++) {
    let year = years[i];

    // Add event listener to each year, but doesn't work...
    year.addEventListener("click", toggleMonth);
  }

  // ------------------------------------------------
  // toggle display of just this one year's months
  function toggleMonth() {
    console.log("\nToggling display of just this one year's months...");

    let year = this;
    let element = year.parentElement; //.parentElement;

    let months = element.querySelector(".calendar-month").classList;
    console.log("Month classes (before) =" + months);
    months.toggle("hidden");
    console.log("Month classes (after) =" + months + "\n");


    let buttonClasses = element.querySelector(".calendar-year>button").classList;
    let iconClasses = element.querySelector(".calendar-year>button>i").classList;

    console.log("buttonClasses (before) =" + buttonClasses);
    console.log("iconClasses (before) =" + iconClasses);

    if (buttonClasses.contains("close-folder")) {
      //console.log("Opening folder");
      buttonClasses.add("open-folder");
      buttonClasses.remove("close-folder");
      months.add("open-folder");
      months.remove("close-folder");
      iconClasses.add("fa-folder-open");
      iconClasses.remove("fa-folder-closed");
    } else {
      //console.log("Closing folder");
      buttonClasses.add("close-folder");
      buttonClasses.remove("open-folder");
      months.add("close-folder");
      months.remove("open-folder");
      iconClasses.add("fa-folder-closed");
      iconClasses.remove("fa-folder-open");
    }

    console.log("buttonClasses (after) =" + buttonClasses);
    console.log("iconClasses (after) =" + iconClasses);
    console.log("-------------------\n");
  }

  function changeView() {
    let viewSelect = document.getElementById("viewSelect");
    switch(viewSelect.options[viewSelect.selectedIndex].text) {
      case "{{ $view1_text }}":
        displayAllYears();
        break;
      case "{{ $view2_text }}":
        displayAllMonths();
        break;
      case "{{ $view3_text }}":
        toggleCalendars();
        break;
      case "{{ $view4_text }}":
        displayEverything();
        break;
      case "{{ $view5_text }}":
        hideEntireCalendar();
        break;
      default:
        alert("Unknown view: " + viewSelect.options[viewSelect.selectedIndex].text);
    }
    // alert("View = " + view);
  }

  // ------------------------------------------------

  // ------------------------------------------------
  // Just Years with insights, no months
  function displayAllYears() {
    // display yearGotArticles
    // hide yearNoArticles
    // hide monthGotArticles
    // hide monthNoArticles
    // hide calendars
  }

  // ------------------------------------------------
  // Just Years with insights, just months with insights
  function displayAllMonths() {
    // display yearGotArticles
    // hide yearNoArticles
    // display monthGotArticles
    // hide monthNoArticles
    // hide calendars
  }

  // ------------------------------------------------
  // All Years, display months and calendars
  function displayEverything() {
    // display yearGotArticles
    // display yearNoArticles
    // display monthGotArticles
    // display monthNoArticles
    // display calendars
    alert("Not implemented!");
  }

  // ------------------------------------------------
  // Hide entire widget
  function hideEntireCalendar() {
    // hide calendar-year
  }

  /* ------------------------------------------------
  // on click, toggle display of months for all years
  function toggleMonths() {
    if (monthsVisible) {
      monthsVisible = false;
    } else {
      monthsVisible = true;
    }

    let years = document.querySelectorAll("[toggle-year]");
    // console.log("# Years = " + years.length);
    for (let i = 0; i < years.length; i++) {
      let year = years[i];
      let element = year.parentElement.parentElement;
      let buttonClasses = element.querySelector(".calendar-year>button").classList;
      if (buttonClasses.contains("close-folder")) {
        openMonths(year);
      } else {
        closeMonths(year);
      }
      /*
      let months = element.querySelector(".calendar-month").classList;
      console.log("Month classes (before) =" + months);
      // months.toggle("hidden");
      //console.log("Month classes (after) =" + months);


      let iconClasses = element.querySelector(".calendar-year>button>i").classList;

      //console.log("Classes (before) =" + classes);
      //console.log("Classes (before) =" + imageClasses);

      if (buttonClasses.contains("close-folder")) {
        //console.log("Opening folder");
        buttonClasses.add("open-folder");
        buttonClasses.remove("close-folder");
        months.add("open-folder");
        months.remove("close-folder");
        iconClasses.add("fa-folder-open");
        iconClasses.remove("fa-folder-closed");
        document.getElementById("toggleMonths").innerHTML = "&nbsp;&nbsp;<i class='fa-regular fa-calendar-days'></i>&nbsp;&nbsp;";
      } else {
        //console.log("Closing folder");
        buttonClasses.add("close-folder");
        buttonClasses.remove("open-folder");
        months.add("close-folder");
        months.remove("open-folder");
        iconClasses.add("fa-folder-closed");
        iconClasses.remove("fa-folder-open");
        document.getElementById("toggleMonths").innerHTML = "&nbsp;&nbsp;<i class='fa-regular fa-calendar-xmark'></i>&nbsp;&nbsp;";
      }


      //console.log("Classes (after) =" + classes);
      //console.log("Classes (after) =" + imageClasses);
    }
  }
  */

  // display all months for the year
  function openMonths(year) {
    let months = document.getElementsByClassName("calendar-month");
    for (let i = 0; i < months.length; i++) {
      months[i].classList.remove("hidden");

      //console.log("Opening folder");
      buttonClasses.add("open-folder");
      buttonClasses.remove("close-folder");
      months.add("open-folder");
      months.remove("close-folder");
      iconClasses.add("fa-folder-open");
      iconClasses.remove("fa-folder-closed");
    }
  }

  // hide all months for the year
  function closeMonths(year) {
    let months = document.getElementsByClassName("calendar-month");
    for (let i = 0; i < months.length; i++) {
      months[i].classList.add("hidden");

      //console.log("Closing folder");
      buttonClasses.add("close-folder");
      buttonClasses.remove("open-folder");
      months.add("close-folder");
      months.remove("open-folder");
      iconClasses.add("fa-folder-closed");
      iconClasses.remove("fa-folder-open");
    }
  }

  // Just Years with insights, just months with insights, plus calendars

  // BUG: Must be run twice to work the first time!
  function toggleCalendars() {
    console.log("toggleCalendars running!!!");
    var months = document.getElementsByClassName("calendar-month-calendar");
    for (let i = 0; i < months.length; i++) {
      if (months[i].style.display === "none") {
        months[i].style.display = "block";
      } else {
        months[i].style.display = "none";
      }
      // attempts to force a refresh/redraw:
      //months[i].style.height = "auto";
      //months[i].offsetHeight;
    }

    // change button appearance to indicate click...
    let toggleClasses = document.getElementById("toggleCalendar").classList;
    //console.log("Button classes (before) =" + toggleClasses);

    if (toggleClasses.contains("bg-cyan-200")) {
      toggleClasses.remove("bg-cyan-200");
      toggleClasses.add("bg-gray-200");
      toggleClasses.toggle("font-semibold");
      document.getElementById("toggleCalendar").innerHTML = "&nbsp;&nbsp;<i class='fa-regular fa-calendar-minus'></i>&nbsp;&nbsp;";
    } else {
      toggleClasses.remove("bg-gray-200");
      toggleClasses.add("bg-cyan-200");
      document.getElementById("toggleCalendar").innerHTML = "&nbsp;&nbsp;<i class='fa-regular fa-calendar-plus'></i>&nbsp;&nbsp;";
    }

    //console.log("Button classes (after) =" + toggleClasses);
  }
</script>
