<!-- Purpose: Display a month of the calendar -->

{{ $context := .context }}
{{ $year := .year }}
{{ $isLeapYear := .isLeapYear }}
{{ $month := .month }}

{{ $daysPerMonth := dict "1" (seq 31) "2" (seq 28) "2-leap" (seq 29) "3" (seq 31) "4" (seq 30) "5" (seq 31) "6" (seq 30) "7" (seq 31) "8" (seq 31) "9" (seq 30) "10" (seq 31) "11" (seq 30) "12" (seq 31) }}
{{ $daysPerWeekMap := dict "Mon" 0 "Tue" 1 "Wed" 2 "Thu" 3 "Fri" 4 "Sat" 5 "Sun" 6 }}
{{ $daysPerWeek := slice "Mon" "Tue" "Wed" "Thu" "Fri" "Sat" "Sun" }}

{{ $context.Scratch.Set "daysThisMonth" (index $daysPerMonth (string $month)) }}

{{ if and $isLeapYear (eq $month 2) }}
  {{ $context.Scratch.Set "daysThisMonth" (index $daysPerMonth "2-leap") }}
{{ end }}

{{ $daysThisMonth := $context.Scratch.Get "daysThisMonth" }}

{{ $monthTwoLetters := printf "%02d" $month }}


<!-- $monthInLetters := dateFormat "January" (string (delimit (slice $year "-" $monthTwoLetters "-01") ""))  }} -->
<!-- above fails with: error calling dateFormat: unable to parse date: -01-01 -->

{{ $monthS := string (delimit (slice $year "-" $monthTwoLetters "-01") "") }}

{{ $monthStr := printf "%04d-%02d-%02d" $year $month 1 }}
{{ $temp := replace $monthStr "[" "" }}
{{ $monthStr2 := replace $temp "]" "" }}


<!--
  year = { $year }} ; month = { $month }}; month2Letters = '{ $monthTwoLetters }}'<br>
  monthS = { $monthS }}; monthStr = { $monthStr }}; monthStr2 = { $monthStr2 }}<br>
-->
{{ $monthInLetters := dateFormat "Jan" ( $monthStr2 ) }}
<!-- $monthInLetters := "January"}} -->

<!-- $firstWeekdayInLetters := dateFormat "Mon" (string (delimit (slice $year "-" $monthTwoLetters "-01") ""))  }} -->
<!-- above gets  error calling dateFormat: unable to parse date: -01-01 -->
<!-- BUG: $firstWeekdayInLetters := dateFormat "Mon" (string (delimit (slice $year "-" $monthTwoLetters "-01") "")) }} -->
<!-- $firstWeekdayInLetters := "Mon" }} -->
{{ $firstWeekdayInLetters := dateFormat "Mon" ($monthStr2) }}


<!--
  firstWeekdayInLetters  = { $firstWeekdayInLetters }}<br>
  -->

{{ $firstWeekdayInNumbers := index $daysPerWeekMap $firstWeekdayInLetters }}
{{ $firstWeekdayMondayOffset := (sub (add $firstWeekdayInNumbers 6) 6) }}


<!-- following gets:
  partials/calendar/month.html:27:22: executing "partials/calendar/month.html" at
  <dateFormat "January" (string (delimit (slice $year "-" $monthTwoLetters "-01") ""))>
  : error calling dateFormat: unable to parse date: -01-01 -->
<!-- original:  $monthInLetters := dateFormat "January" (string (delimit (slice $year "-" $monthTwoLetters "-01") "")) }}
 $monthInLetters := "February" }}
-->

{{ $articlesThisMonth := index ($context.Scratch.Get "ArticlesPerMonth") (string (delimit (slice $year $monthTwoLetters) "-")) }}

{{ if gt $articlesThisMonth 0 }}
  <div class="calendar-month">
    <header class="font-bold">
      <a href="/archive/{{ delimit (slice $year $month) "-" }}/">{{ $monthInLetters }} <span class="calendar-monthTotals">( {{ $articlesThisMonth }} )</span> </a>
    </header>

    <div class="calendar-monthCalendar">
      <!-- List days of the week as column headings -->
      <ul class="calendar-weekdays">
        {{- range $daysPerWeek -}}
          <li class="calendar-weekday-{{ lower . }}">{{ . }}</li>
        {{- end -}}
      </ul>

      <!-- List days of the month in a calendar format -->
      <ul class="calendar-days">
        {{ range seq $firstWeekdayMondayOffset }}
          <li class="calendar-day-empty"></li>
        {{ end }}

        {{ range $daysThisMonth }}
          {{ partial "calendar/day" (dict "context" $context "year" $year "month" $month "day" .) (string (delimit (slice $year $month .) "")) }}
        {{ end }}

        {{ range (seq (mod (add (len $daysThisMonth) $firstWeekdayMondayOffset) 7)) }}
          <li class="calendar-day-empty"></li>
        {{ end }}

      </ul>
    </div>
  </div>
{{ end }}
